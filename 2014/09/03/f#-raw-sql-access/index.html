<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="F# Raw SQL Access" />
<meta property="og:description" content="With my start in working with F#, I came to the point to access a database. When you read my last post, you know that an ORM was out of question. What me really surprised at the end, was that the code is much less than every other DB access I wrote.
So how does it look?
The general idea was, to first create a record that holds the SQL statement and the parameters, that gets then executed." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willich.io/2014/09/03/f#-raw-sql-access/" />
<meta property="article:published_time" content="2014-09-03T19:53:26&#43;01:00"/>
<meta property="article:modified_time" content="2014-09-03T19:53:26&#43;01:00"/>

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="F# Raw SQL Access"/>
<meta name="twitter:description" content="With my start in working with F#, I came to the point to access a database. When you read my last post, you know that an ORM was out of question. What me really surprised at the end, was that the code is much less than every other DB access I wrote.
So how does it look?
The general idea was, to first create a record that holds the SQL statement and the parameters, that gets then executed."/>



    <link rel="canonical" href="https://willich.io/2014/09/03/f#-raw-sql-access/">

    <title>
      
        F# Raw SQL Access | Hi, I&#39;m Andreas
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://willich.io/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-light bg-light">
        <a class="navbar-brand" href="/">
            Hi, I&#39;m Andreas
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/about/">About</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/blog/">Blog</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/speaking/">Speaking</a>
                    
                </li>
                
            </ul>
            
        </div>
    </nav>
</header>

    

    
    <div class="container">
      <div class="row">
        <div class="col-12 blog-main">

          

<header>
    <h2 class="blog-post-title">
        <a class="text-dark" href="/2014/09/03/f#-raw-sql-access/">F# Raw SQL Access</a>
    </h2>
    


<div class="blog-post-date text-secondary">
    
        Sep 3, 2014
    
</div>

    
    
    <hr>
</header>
<article class="blog-post">
    <p>With my start in working with F#, I came to the point to access a database. When you read my last post, you know that an ORM was out of question. What me really surprised at the end, was that the code is much less than every other DB access I wrote.</p>

<p>So how does it look?</p>

<p>The general idea was, to first create a record that holds the SQL statement and the parameters, that gets then executed.</p>

<p>The record enables you to write tests for your database access.</p>

<p>For accessing the ADO.Net functions, I use FsSql.</p>

<p>So beginn with the entity with represents one row of the table:</p>

<pre><code class="language-fsharp">type Weather() =
    member val Id = 0 with get,set
 
    member val LocationId = Guid.Empty with get,set
    member val DataFrom = DateTimeOffset.MinValue with get,set
    member val DataTo = DateTimeOffset.MinValue with get,set
    member val Temperature = 0.0m with get,set
    member val Humidity = 0.0m with get,set
    member val Rain = 0.0m with get,set
    member val WindSpeed = 0.0m with get,set
    member val WindDirection = 0.0m with get,set
    member val Clouds = 0.0m with get,set
    member val Pressure = 0.0m with get,set
</code></pre>

<p>It‚Äôs a simple store for weather data for a location.</p>

<p>To insert an entry to the table, we need a function to get the wrapper record:</p>

<pre><code class="language-fsharp">let private insert (weather : Weather ) =
{
    query = &quot;INSERT INTO \&quot;intersect\&quot;.\&quot;Weather\&quot;(
                         locationid, datafrom, datato, temperature, humidity, rain,
                         windspeed, winddirection, clouds, pressure)
             VALUES (@locationid, @datafrom, @datato, @temperature, @humidity, @rain,
                     @windspeed, @winddirection, @clouds, @pressure);
             RETURNING id;&quot;;
    parameters = [
                 P(&quot;@locationid&quot;, weather.LocationId);
                 P(&quot;@datafrom&quot;, weather.DataFrom);
                 P(&quot;@datato&quot;, weather.DataTo);
                 P(&quot;@temperature&quot;, weather.Temperature);
                 P(&quot;@humidity&quot;, weather.Humidity);
                 P(&quot;@rain&quot;, weather.Rain);
                 P(&quot;@windspeed&quot;, weather.WindSpeed);
                 P(&quot;@winddirection&quot;, weather.WindDirection);
                 P(&quot;@clouds&quot;, weather.Clouds);
                 P(&quot;@pressure&quot;, weather.Pressure);
             ]
}
</code></pre>

<p>The wrapper has the query as string and a list of SqlParameters.</p>

<pre><code class="language-fsharp">type changeQueryObject =
{
    query : string;
    parameters : Sql.Parameter list;
}
</code></pre>

<p>The P- function is a shortcut for the FsSql Sql.Parameter.make.</p>

<p>To execute the insert statement, we pass the changeQueryObject to following function:</p>

<pre><code class="language-fsharp">let executeScalar (queryObj : changeQueryObject) =
    sql.ExecScalar queryObj.query queryObj.parameters
</code></pre>

<p>With the ‚ÄúRETURNING id‚Äù at the end of the SQL statement and executing it with ExecScalar, we get the primary key of the new entry. Everything we want after the insert.</p>

<p>The same works for updates:</p>

<pre><code class="language-fsharp">let private update (weather : Weather ) =
{
    query = &quot;UPDATE \&quot;intersect\&quot;.\&quot;Weather\&quot;
             SET locationid=@locationid, datafrom=@datafrom, datato=@datato, temperature=@temperature, humidity=@humidity,
             rain=@rain, windspeed=@windspeed, winddirection=@winddirection, clouds=@clouds, pressure=@pressure
             WHERE id=@id;
             SELECT @id;
             &quot;;
    parameters = [
                    P(&quot;@id&quot;, weather.Id);
                    P(&quot;@locationid&quot;, weather.LocationId);
                    P(&quot;@datafrom&quot;, weather.DataFrom);
                    P(&quot;@datato&quot;, weather.DataTo);
                    P(&quot;@temperature&quot;, weather.Temperature);
                    P(&quot;@humidity&quot;, weather.Humidity);
                    P(&quot;@rain&quot;, weather.Rain);
                    P(&quot;@windspeed&quot;, weather.WindSpeed);
                    P(&quot;@winddirection&quot;, weather.WindDirection);
                    P(&quot;@clouds&quot;, weather.Clouds);
                    P(&quot;@pressure&quot;, weather.Pressure);
                 ]
}
</code></pre>

<p>And with some little pattern matching, we get a nice save function:</p>

<pre><code class="language-fsharp">let save (weather : Weather) =
    match weather.Id with
    | 0 -&gt; insert weather
    | _ -&gt; update weather
</code></pre>

<p>But what is with querying and some filtering? Now F# plays it‚Äôs strength.</p>

<p>For that we need an little changed query wrapper:</p>

<pre><code class="language-fsharp">type selectQueryObject&lt;'T&gt; =
{
    query : string;
    parameters : Sql.Parameter list;
    deserialisation : (IDataRecord -&gt; 'T) option;
}
</code></pre>

<p>The new field ‚Äúdeserialisation‚Äù holds an function to get an instance of the entity from a datarecord. This is the one for the weather entity.</p>

<pre><code class="language-fsharp">let asWeather (r: IDataRecord) =
    new Weather(Id = (r?id).Value, LocationId = (r?LocationId).Value, DataFrom = (r?DataFrom).Value,
    DataTo = (r?DataTo).Value, Temperature = (r?Temperature).Value,
    Humidity = (r?Humidity).Value, Rain = (r?Rain).Value, WindSpeed = (r?WindSpeed).Value,
    WindDirection = (r?WindDirection).Value, Clouds = (r?Clouds).Value, Pressure = (r?Pressure).Value)
</code></pre>

<p>How looks the querying function?</p>

<pre><code class="language-fsharp">let search (fc : WeatherSearchRequest) =
    let query = &quot;SELECT id, locationid, datafrom, datato, temperature, humidity, rain, windspeed, winddirection, clouds, pressure FROM \&quot;intersect\&quot;.\&quot;Weather\&quot;&quot;
 
    let locationIdPara = w &quot;locationid&quot; &quot;@locationid&quot; &quot;=&quot; fc.LocationId
    let fomPara = w &quot;datafrom&quot; &quot;@datafrom&quot; &quot;&gt;=&quot; fc.From
    let toPara = w &quot;datato&quot; &quot;@datato&quot; &quot;&lt;=&quot; fc.To
    let datetimeFromPara = w &quot;datafrom&quot; &quot;@datafrom&quot; &quot;&gt;=&quot; fc.DateTime
    let datetimeToPara = w &quot;datato&quot; &quot;@datato&quot; &quot;&lt;=&quot; fc.DateTime
 
    Some asWeather
    |&gt; emptyQueryPart
    |&gt; combineAnd locationIdPara
    |&gt; combineAnd fomPara
    |&gt; combineAnd toPara
    |&gt; combineAnd datetimeFromPara
    |&gt; combineAnd datetimeToPara
    |&gt; combineQueryParts query
</code></pre>

<p>The WeatherSearchRequest is a POCO which holds the various filter values.</p>

<p>Every possible part of the where- Statement is wrapped in an queryPart record.</p>

<pre><code class="language-fsharp">type queryPart =
{
    where : string;
    parameter : Sql.Parameter option
}
</code></pre>

<p>The w- function (for Where) creates such a record:</p>

<pre><code class="language-fsharp">let private w&lt;'a when 'a : (new : unit -&gt; 'a) and 'a : struct and 'a :&gt; System.ValueType&gt; column parametername operator (value : System.Nullable&lt;'a&gt;) =
    match value.HasValue with
    | true -&gt; { where = sprintf &quot;%s %s %s&quot; column operator parametername; parameter = Some &lt;| P(parametername, value.Value)}
    | false -&gt; {where = &quot;&quot;; parameter = Option&lt;Sql.Parameter&gt;.None}
</code></pre>

<p>When the filter value is set, it create a filled queryPart, else we get an empty one.</p>

<p>But what do we do with it now? Let‚Äôs look at the next code block.</p>

<pre><code class="language-fsharp">Some asWeather
|&gt; emptyQueryPart
...
</code></pre>

<p>This is to create a selectQueryObject with setted deserialisation function. The selectQueryObject is then piped to multiple combineAnd functions.</p>

<pre><code class="language-fsharp">...
|&gt; combineAnd locationIdPara
|&gt; combineAnd fomPara
|&gt; combineAnd toPara
|&gt; combineAnd datetimeFromPara
|&gt; combineAnd datetimeToPara
...

let private combineAnd&lt;'T&gt; (x : queryPart) (qo : selectQueryObject&lt;'T&gt;) =
    match (x.parameter, qo.query) with
    | (Some xpart, &quot;&quot;) -&gt; { query = x.where; parameters = [x.parameter.Value]; deserialisation = qo.deserialisation}
    | (Some xpart, _) -&gt; {query = qo.query + &quot; AND &quot; + x.where; parameters = x.parameter.Value :: qo.parameters; deserialisation = qo.deserialisation}
    | (None, _) -&gt; { query = qo.query; parameters = qo.parameters; deserialisation = qo.deserialisation}

</code></pre>

<p>Once again, we use some pattern matching.</p>

<p>The first case is hit, when we have a filled queryPart but an empty selectQueryObject. So when the first filter criteria is hit.</p>

<p>The second case is hit, when we add the other filter criteria to the selectQueryObject.</p>

<p>The last one is hit, when we have already some data in the selectQueryObject, but the queryPart is empty. So when we have already some filter criteria added, but the current one is not set.</p>

<p>At the end, we pipe the selectQueryObject to the combineQueryParts function.</p>

<pre><code class="language-fsharp">...
|&gt; combineQueryParts query
...
 
let private combineQueryParts&lt;'T&gt; (query :string) (qo :selectQueryObject&lt;'T&gt;) =
    let mutable q = query
    if (qo.query.Length &gt; 0) then
        q &lt;- query + &quot; WHERE &quot; + qo.query
 
    { query = q; parameters = qo.parameters; deserialisation = qo.deserialisation; }

</code></pre>

<p>This function simply combines the select- Query with the where- Statement if needed.</p>

<p>At the end, we get a nice filled selectQueryObject which is then passed to a general function.</p>

<pre><code class="language-fsharp">let executeReader&lt;'T&gt; (queryObj : selectQueryObject&lt;'T&gt; )=
    sql.ExecReader queryObj.query queryObj.parameters
    |&gt; Seq.ofDataReader
    |&gt; Seq.map queryObj.deserialisation.Value
</code></pre>

<p>Nice, or?</p>

<p>The complete code at once can be found here.</p>

<p>So what about the testing? With the query wrapped into a record, we simply can tests the data in the record.</p>

<pre><code class="language-fsharp">let checkSqlParameter (name : string) (value : obj) (parameter : Sql.Parameter) =
    obj.Equals(parameter.ParameterName,name) &amp;&amp; obj.Equals(parameter.Value,value)
 
let checkForSqlParameter (name : string) (value : obj) parameters =
    parameters |&gt; Seq.exists (fun i -&gt; checkSqlParameter name value i) |&gt; should equal true
 
let nullableFromPara = new Nullable&lt;DateTimeOffset&gt;(fromPara)
let nullableToPara = new Nullable&lt;DateTimeOffset&gt;(toPara)
let locationIdPara = new Nullable&lt;Guid&gt;(Guid.NewGuid())
 
[&lt;Fact&gt;]
let ``Check query with LocationId, From and To parameter``() =
    let fc = new WeatherSearchRequest()
    fc.LocationId &lt;- locationIdPara
    fc.From &lt;- nullableFromPara
    fc.To &lt;- nullableToPara
 
    let queryObj = weather.search fc
    queryObj.parameters |&gt; Seq.length |&gt; should equal 3
    queryObj.parameters |&gt; checkForSqlParameter &quot;@datafrom&quot; fc.From
    queryObj.parameters |&gt; checkForSqlParameter &quot;@datato&quot; fc.To
    queryObj.parameters |&gt; checkForSqlParameter &quot;@locationid&quot; fc.LocationId
 
    queryObj.query |&gt; should equal &quot;SELECT id, locationid, datafrom, datato, temperature, humidity, rain, windspeed, winddirection, clouds, pressure FROM \&quot;intersect\&quot;.\&quot;Weather\&quot; WHERE locationid = @locationid AND datafrom &gt;= @datafrom AND datato &lt;= @datato&quot;

</code></pre>

<p>When was the last time, you could test which SQL- query gets executed against your DBS? üòâ</p>


    

    


    <br/>
    <br/>
    <br/>
    <br/>
    &nbsp;
</article>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
    
        <section>
    
        
    
        
    
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
      






<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Disclaimer: The opinions expressed herein are my own personal opinions and do not represent my employer‚Äôs view in any way.</p>
        <p class="w-100 text-center">Hugo template made with ‚ù§ by <a href="https://github.com/Xzya">Xzya</a>, inspired by <a href="https://github.com/alanorth/hugo-theme-bootstrap4-blog">hugo-theme-bootstrap4-blog</a></p>
    </nav>
</footer>

    

    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
