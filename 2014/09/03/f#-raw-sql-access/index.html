<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="F# Raw SQL Access" />
<meta property="og:description" content="With my start in working with F#, I came to the point to access a database. When you read my last post, you know that an ORM was out of question. What me really surprised at the end, was that the code is much less than every other DB access I wrote.
So how does it look?
The general idea was, to first create a record that holds the SQL statement and the parameters, that gets then executed." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://willich.io/2014/09/03/f#-raw-sql-access/" />
<meta property="article:published_time" content="2014-09-03T19:53:26+01:00" />
<meta property="article:modified_time" content="2014-09-03T19:53:26+01:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="F# Raw SQL Access"/>
<meta name="twitter:description" content="With my start in working with F#, I came to the point to access a database. When you read my last post, you know that an ORM was out of question. What me really surprised at the end, was that the code is much less than every other DB access I wrote.
So how does it look?
The general idea was, to first create a record that holds the SQL statement and the parameters, that gets then executed."/>



    <link rel="canonical" href="https://willich.io/2014/09/03/f#-raw-sql-access/">

    <title>
      
        F# Raw SQL Access | Hi, I&#39;m Andreas
      
    </title>

    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://willich.io/css/style.css" rel="stylesheet">

    

    

    
  </head>
  <body>
    
      

<header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-light bg-light">
        <a class="navbar-brand" href="/">
            Hi, I&#39;m Andreas
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/about/">About</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/blog/">Blog</a>
                    
                </li>
                
            </ul>
            
        </div>
    </nav>
</header>

    

    
    <div class="container">
      <div class="row">
        <div class="col-12 blog-main">

          

<header>
    <h2 class="blog-post-title">
        <a class="text-dark" href="/2014/09/03/f#-raw-sql-access/">F# Raw SQL Access</a>
    </h2>
    


<div class="blog-post-date text-secondary">
    
        Sep 3, 2014
    
</div>

    
    
    <hr>
</header>
<article class="blog-post">
    <p>With my start in working with F#, I came to the point to access a database. When you read my last post, you know that an ORM was out of question. What me really surprised at the end, was that the code is much less than every other DB access I wrote.</p>
<p>So how does it look?</p>
<p>The general idea was, to first create a record that holds the SQL statement and the parameters, that gets then executed.</p>
<p>The record enables you to write tests for your database access.</p>
<p>For accessing the ADO.Net functions, I use FsSql.</p>
<p>So beginn with the entity with represents one row of the table:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Weather</span>() <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> Id <span style="color:#f92672">=</span> 0 <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
 
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> LocationId <span style="color:#f92672">=</span> Guid.Empty <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> DataFrom <span style="color:#f92672">=</span> DateTimeOffset.MinValue <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> DataTo <span style="color:#f92672">=</span> DateTimeOffset.MinValue <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> Temperature <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0m <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> Humidity <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0m <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> Rain <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0m <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> WindSpeed <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0m <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> WindDirection <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0m <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> Clouds <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0m <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
    <span style="color:#66d9ef">member</span> <span style="color:#66d9ef">val</span> Pressure <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0m <span style="color:#66d9ef">with</span> get<span style="color:#f92672">,</span>set
</code></pre></div><p>It’s a simple store for weather data for a location.</p>
<p>To insert an entry to the table, we need a function to get the wrapper record:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> private insert <span style="color:#f92672">(</span>weather <span style="color:#f92672">:</span> Weather <span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
<span style="color:#f92672">{</span>
    query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;INSERT INTO </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">intersect</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">Weather</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">(
</span><span style="color:#e6db74">                         locationid, datafrom, datato, temperature, humidity, rain,
</span><span style="color:#e6db74">                         windspeed, winddirection, clouds, pressure)
</span><span style="color:#e6db74">             VALUES (@locationid, @datafrom, @datato, @temperature, @humidity, @rain,
</span><span style="color:#e6db74">                     @windspeed, @winddirection, @clouds, @pressure);
</span><span style="color:#e6db74">             RETURNING id;&#34;</span><span style="color:#f92672">;</span>
    parameters <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@locationid&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>LocationId<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@datafrom&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>DataFrom<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@datato&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>DataTo<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@temperature&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Temperature<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@humidity&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Humidity<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@rain&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Rain<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@windspeed&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>WindSpeed<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@winddirection&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>WindDirection<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@clouds&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Clouds<span style="color:#f92672">);</span>
                 P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@pressure&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Pressure<span style="color:#f92672">);</span>
             <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>The wrapper has the query as string and a list of SqlParameters.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">changeQueryObject</span> <span style="color:#f92672">=</span>
<span style="color:#f92672">{</span>
    query <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">;</span>
    parameters <span style="color:#f92672">:</span> Sql.Parameter <span style="color:#66d9ef">list</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>The P- function is a shortcut for the FsSql Sql.Parameter.make.</p>
<p>To execute the insert statement, we pass the changeQueryObject to following function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> executeScalar <span style="color:#f92672">(</span>queryObj <span style="color:#f92672">:</span> changeQueryObject<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
    sql<span style="color:#f92672">.</span>ExecScalar queryObj<span style="color:#f92672">.</span>query queryObj<span style="color:#f92672">.</span>parameters
</code></pre></div><p>With the “RETURNING id” at the end of the SQL statement and executing it with ExecScalar, we get the primary key of the new entry. Everything we want after the insert.</p>
<p>The same works for updates:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> private update <span style="color:#f92672">(</span>weather <span style="color:#f92672">:</span> Weather <span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
<span style="color:#f92672">{</span>
    query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;UPDATE </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">intersect</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">Weather</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">
</span><span style="color:#e6db74">             SET locationid=@locationid, datafrom=@datafrom, datato=@datato, temperature=@temperature, humidity=@humidity,
</span><span style="color:#e6db74">             rain=@rain, windspeed=@windspeed, winddirection=@winddirection, clouds=@clouds, pressure=@pressure
</span><span style="color:#e6db74">             WHERE id=@id;
</span><span style="color:#e6db74">             SELECT @id;
</span><span style="color:#e6db74">             &#34;</span><span style="color:#f92672">;</span>
    parameters <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@id&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Id<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@locationid&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>LocationId<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@datafrom&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>DataFrom<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@datato&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>DataTo<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@temperature&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Temperature<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@humidity&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Humidity<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@rain&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Rain<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@windspeed&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>WindSpeed<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@winddirection&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>WindDirection<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@clouds&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Clouds<span style="color:#f92672">);</span>
                    P<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;@pressure&#34;</span><span style="color:#f92672">,</span> weather<span style="color:#f92672">.</span>Pressure<span style="color:#f92672">);</span>
                 <span style="color:#f92672">]</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>And with some little pattern matching, we get a nice save function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> save <span style="color:#f92672">(</span>weather <span style="color:#f92672">:</span> Weather<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">match</span> weather<span style="color:#f92672">.</span>Id <span style="color:#66d9ef">with</span>
    <span style="color:#f92672">|</span> 0 <span style="color:#f92672">-&gt;</span> insert weather
    <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> update weather
</code></pre></div><p>But what is with querying and some filtering? Now F# plays it’s strength.</p>
<p>For that we need an little changed query wrapper:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">selectQueryObject</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
<span style="color:#f92672">{</span>
    query <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">;</span>
    parameters <span style="color:#f92672">:</span> Sql.Parameter <span style="color:#66d9ef">list</span><span style="color:#f92672">;</span>
    deserialisation <span style="color:#f92672">:</span> <span style="color:#f92672">(</span>IDataRecord <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">&#39;</span>T<span style="color:#f92672">)</span> option<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>The new field “deserialisation” holds an function to get an instance of the entity from a datarecord. This is the one for the weather entity.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> asWeather <span style="color:#f92672">(</span>r<span style="color:#f92672">:</span> IDataRecord<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">new</span> Weather<span style="color:#f92672">(</span>Id <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>id<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span> LocationId <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>LocationId<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span> DataFrom <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>DataFrom<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span>
    DataTo <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>DataTo<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span> Temperature <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>Temperature<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span>
    Humidity <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>Humidity<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span> Rain <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>Rain<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span> WindSpeed <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>WindSpeed<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span>
    WindDirection <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>WindDirection<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span> Clouds <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>Clouds<span style="color:#f92672">).</span>Value<span style="color:#f92672">,</span> Pressure <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>r<span style="color:#f92672">?</span>Pressure<span style="color:#f92672">).</span>Value<span style="color:#f92672">)</span>
</code></pre></div><p>How looks the querying function?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> search <span style="color:#f92672">(</span>fc <span style="color:#f92672">:</span> WeatherSearchRequest<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">let</span> query <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT id, locationid, datafrom, datato, temperature, humidity, rain, windspeed, winddirection, clouds, pressure FROM </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">intersect</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">Weather</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">&#34;</span>
 
    <span style="color:#66d9ef">let</span> locationIdPara <span style="color:#f92672">=</span> w <span style="color:#e6db74">&#34;locationid&#34;</span> <span style="color:#e6db74">&#34;@locationid&#34;</span> <span style="color:#e6db74">&#34;=&#34;</span> fc<span style="color:#f92672">.</span>LocationId
    <span style="color:#66d9ef">let</span> fomPara <span style="color:#f92672">=</span> w <span style="color:#e6db74">&#34;datafrom&#34;</span> <span style="color:#e6db74">&#34;@datafrom&#34;</span> <span style="color:#e6db74">&#34;&gt;=&#34;</span> fc<span style="color:#f92672">.</span>From
    <span style="color:#66d9ef">let</span> toPara <span style="color:#f92672">=</span> w <span style="color:#e6db74">&#34;datato&#34;</span> <span style="color:#e6db74">&#34;@datato&#34;</span> <span style="color:#e6db74">&#34;&lt;=&#34;</span> fc<span style="color:#f92672">.</span>To
    <span style="color:#66d9ef">let</span> datetimeFromPara <span style="color:#f92672">=</span> w <span style="color:#e6db74">&#34;datafrom&#34;</span> <span style="color:#e6db74">&#34;@datafrom&#34;</span> <span style="color:#e6db74">&#34;&gt;=&#34;</span> fc<span style="color:#f92672">.</span>DateTime
    <span style="color:#66d9ef">let</span> datetimeToPara <span style="color:#f92672">=</span> w <span style="color:#e6db74">&#34;datato&#34;</span> <span style="color:#e6db74">&#34;@datato&#34;</span> <span style="color:#e6db74">&#34;&lt;=&#34;</span> fc<span style="color:#f92672">.</span>DateTime
 
    Some asWeather
    <span style="color:#f92672">|&gt;</span> emptyQueryPart
    <span style="color:#f92672">|&gt;</span> combineAnd locationIdPara
    <span style="color:#f92672">|&gt;</span> combineAnd fomPara
    <span style="color:#f92672">|&gt;</span> combineAnd toPara
    <span style="color:#f92672">|&gt;</span> combineAnd datetimeFromPara
    <span style="color:#f92672">|&gt;</span> combineAnd datetimeToPara
    <span style="color:#f92672">|&gt;</span> combineQueryParts query
</code></pre></div><p>The WeatherSearchRequest is a POCO which holds the various filter values.</p>
<p>Every possible part of the where- Statement is wrapped in an queryPart record.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">queryPart</span> <span style="color:#f92672">=</span>
<span style="color:#f92672">{</span>
    where <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">;</span>
    parameter <span style="color:#f92672">:</span> Sql.Parameter option
<span style="color:#f92672">}</span>
</code></pre></div><p>The w- function (for Where) creates such a record:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> private w<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>a <span style="color:#66d9ef">when</span> <span style="color:#66d9ef">&#39;</span>a <span style="color:#f92672">:</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">unit</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">&#39;</span>a<span style="color:#f92672">)</span> <span style="color:#f92672">and</span> <span style="color:#66d9ef">&#39;</span>a <span style="color:#f92672">:</span> <span style="color:#66d9ef">struct</span> <span style="color:#f92672">and</span> <span style="color:#66d9ef">&#39;</span>a <span style="color:#f92672">:&gt;</span> System.ValueType<span style="color:#f92672">&gt;</span> column parametername operator <span style="color:#f92672">(</span>value <span style="color:#f92672">:</span> System.Nullable<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>a<span style="color:#f92672">&gt;)</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">match</span> value<span style="color:#f92672">.</span>HasValue <span style="color:#66d9ef">with</span>
    <span style="color:#f92672">|</span> <span style="color:#66d9ef">true</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span> where <span style="color:#f92672">=</span> sprintf <span style="color:#e6db74">&#34;%s %s %s&#34;</span> column operator parametername<span style="color:#f92672">;</span> parameter <span style="color:#f92672">=</span> Some <span style="color:#f92672">&lt;|</span> P<span style="color:#f92672">(</span>parametername<span style="color:#f92672">,</span> value<span style="color:#f92672">.</span>Value<span style="color:#f92672">)}</span>
    <span style="color:#f92672">|</span> <span style="color:#66d9ef">false</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>where <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span> parameter <span style="color:#f92672">=</span> Option<span style="color:#f92672">&lt;</span>Sql.Parameter<span style="color:#f92672">&gt;.</span>None<span style="color:#f92672">}</span>
</code></pre></div><p>When the filter value is set, it create a filled queryPart, else we get an empty one.</p>
<p>But what do we do with it now? Let’s look at the next code block.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp">Some asWeather
<span style="color:#f92672">|&gt;</span> emptyQueryPart
<span style="color:#f92672">...</span>
</code></pre></div><p>This is to create a selectQueryObject with setted deserialisation function. The selectQueryObject is then piped to multiple combineAnd functions.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#f92672">...</span>
<span style="color:#f92672">|&gt;</span> combineAnd locationIdPara
<span style="color:#f92672">|&gt;</span> combineAnd fomPara
<span style="color:#f92672">|&gt;</span> combineAnd toPara
<span style="color:#f92672">|&gt;</span> combineAnd datetimeFromPara
<span style="color:#f92672">|&gt;</span> combineAnd datetimeToPara
<span style="color:#f92672">...</span>

<span style="color:#66d9ef">let</span> private combineAnd<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">(</span>x <span style="color:#f92672">:</span> queryPart<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>qo <span style="color:#f92672">:</span> selectQueryObject<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>T<span style="color:#f92672">&gt;)</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">match</span> <span style="color:#f92672">(</span>x<span style="color:#f92672">.</span>parameter<span style="color:#f92672">,</span> qo<span style="color:#f92672">.</span>query<span style="color:#f92672">)</span> <span style="color:#66d9ef">with</span>
    <span style="color:#f92672">|</span> <span style="color:#f92672">(</span>Some xpart<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span> query <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>where<span style="color:#f92672">;</span> parameters <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>x<span style="color:#f92672">.</span>parameter<span style="color:#f92672">.</span>Value<span style="color:#f92672">];</span> deserialisation <span style="color:#f92672">=</span> qo<span style="color:#f92672">.</span>deserialisation<span style="color:#f92672">}</span>
    <span style="color:#f92672">|</span> <span style="color:#f92672">(</span>Some xpart<span style="color:#f92672">,</span> <span style="color:#f92672">_)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>query <span style="color:#f92672">=</span> qo<span style="color:#f92672">.</span>query <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; AND &#34;</span> <span style="color:#f92672">+</span> x<span style="color:#f92672">.</span>where<span style="color:#f92672">;</span> parameters <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>parameter<span style="color:#f92672">.</span>Value <span style="color:#f92672">::</span> qo<span style="color:#f92672">.</span>parameters<span style="color:#f92672">;</span> deserialisation <span style="color:#f92672">=</span> qo<span style="color:#f92672">.</span>deserialisation<span style="color:#f92672">}</span>
    <span style="color:#f92672">|</span> <span style="color:#f92672">(</span>None<span style="color:#f92672">,</span> <span style="color:#f92672">_)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span> query <span style="color:#f92672">=</span> qo<span style="color:#f92672">.</span>query<span style="color:#f92672">;</span> parameters <span style="color:#f92672">=</span> qo<span style="color:#f92672">.</span>parameters<span style="color:#f92672">;</span> deserialisation <span style="color:#f92672">=</span> qo<span style="color:#f92672">.</span>deserialisation<span style="color:#f92672">}</span>

</code></pre></div><p>Once again, we use some pattern matching.</p>
<p>The first case is hit, when we have a filled queryPart but an empty selectQueryObject. So when the first filter criteria is hit.</p>
<p>The second case is hit, when we add the other filter criteria to the selectQueryObject.</p>
<p>The last one is hit, when we have already some data in the selectQueryObject, but the queryPart is empty. So when we have already some filter criteria added, but the current one is not set.</p>
<p>At the end, we pipe the selectQueryObject to the combineQueryParts function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#f92672">...</span>
<span style="color:#f92672">|&gt;</span> combineQueryParts query
<span style="color:#f92672">...</span>
 
<span style="color:#66d9ef">let</span> private combineQueryParts<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">(</span>query <span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>qo <span style="color:#f92672">:</span>selectQueryObject<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>T<span style="color:#f92672">&gt;)</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">let</span> mutable q <span style="color:#f92672">=</span> query
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>qo<span style="color:#f92672">.</span>query<span style="color:#f92672">.</span>Length <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#66d9ef">then</span>
        q <span style="color:#f92672">&lt;-</span> query <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; WHERE &#34;</span> <span style="color:#f92672">+</span> qo<span style="color:#f92672">.</span>query
 
    <span style="color:#f92672">{</span> query <span style="color:#f92672">=</span> q<span style="color:#f92672">;</span> parameters <span style="color:#f92672">=</span> qo<span style="color:#f92672">.</span>parameters<span style="color:#f92672">;</span> deserialisation <span style="color:#f92672">=</span> qo<span style="color:#f92672">.</span>deserialisation<span style="color:#f92672">;</span> <span style="color:#f92672">}</span>

</code></pre></div><p>This function simply combines the select- Query with the where- Statement if needed.</p>
<p>At the end, we get a nice filled selectQueryObject which is then passed to a general function.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> executeReader<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">(</span>queryObj <span style="color:#f92672">:</span> selectQueryObject<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">&#39;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#f92672">)=</span>
    sql<span style="color:#f92672">.</span>ExecReader queryObj<span style="color:#f92672">.</span>query queryObj<span style="color:#f92672">.</span>parameters
    <span style="color:#f92672">|&gt;</span> Seq.ofDataReader
    <span style="color:#f92672">|&gt;</span> Seq.map queryObj<span style="color:#f92672">.</span>deserialisation<span style="color:#f92672">.</span>Value
</code></pre></div><p>Nice, or?</p>
<p>The complete code at once can be found here.</p>
<p>So what about the testing? With the query wrapped into a record, we simply can tests the data in the record.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fsharp" data-lang="fsharp"><span style="color:#66d9ef">let</span> checkSqlParameter <span style="color:#f92672">(</span>name <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>value <span style="color:#f92672">:</span> <span style="color:#66d9ef">obj</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>parameter <span style="color:#f92672">:</span> Sql.Parameter<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">obj</span><span style="color:#f92672">.</span>Equals<span style="color:#f92672">(</span>parameter<span style="color:#f92672">.</span>ParameterName<span style="color:#f92672">,</span>name<span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#66d9ef">obj</span><span style="color:#f92672">.</span>Equals<span style="color:#f92672">(</span>parameter<span style="color:#f92672">.</span>Value<span style="color:#f92672">,</span>value<span style="color:#f92672">)</span>
 
<span style="color:#66d9ef">let</span> checkForSqlParameter <span style="color:#f92672">(</span>name <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span>value <span style="color:#f92672">:</span> <span style="color:#66d9ef">obj</span><span style="color:#f92672">)</span> parameters <span style="color:#f92672">=</span>
    parameters <span style="color:#f92672">|&gt;</span> Seq.exists <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> i <span style="color:#f92672">-&gt;</span> checkSqlParameter name value i<span style="color:#f92672">)</span> <span style="color:#f92672">|&gt;</span> should equal <span style="color:#66d9ef">true</span>
 
<span style="color:#66d9ef">let</span> nullableFromPara <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Nullable<span style="color:#f92672">&lt;</span>DateTimeOffset<span style="color:#f92672">&gt;(</span>fromPara<span style="color:#f92672">)</span>
<span style="color:#66d9ef">let</span> nullableToPara <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Nullable<span style="color:#f92672">&lt;</span>DateTimeOffset<span style="color:#f92672">&gt;(</span>toPara<span style="color:#f92672">)</span>
<span style="color:#66d9ef">let</span> locationIdPara <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Nullable<span style="color:#f92672">&lt;</span>Guid<span style="color:#f92672">&gt;(</span>Guid.NewGuid()<span style="color:#f92672">)</span>
 
<span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
<span style="color:#66d9ef">let</span> ``Check query with LocationId, From and To parameter``() <span style="color:#f92672">=</span>
    <span style="color:#66d9ef">let</span> fc <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> WeatherSearchRequest()
    fc<span style="color:#f92672">.</span>LocationId <span style="color:#f92672">&lt;-</span> locationIdPara
    fc<span style="color:#f92672">.</span>From <span style="color:#f92672">&lt;-</span> nullableFromPara
    fc<span style="color:#f92672">.</span>To <span style="color:#f92672">&lt;-</span> nullableToPara
 
    <span style="color:#66d9ef">let</span> queryObj <span style="color:#f92672">=</span> weather<span style="color:#f92672">.</span>search fc
    queryObj<span style="color:#f92672">.</span>parameters <span style="color:#f92672">|&gt;</span> Seq.length <span style="color:#f92672">|&gt;</span> should equal 3
    queryObj<span style="color:#f92672">.</span>parameters <span style="color:#f92672">|&gt;</span> checkForSqlParameter <span style="color:#e6db74">&#34;@datafrom&#34;</span> fc<span style="color:#f92672">.</span>From
    queryObj<span style="color:#f92672">.</span>parameters <span style="color:#f92672">|&gt;</span> checkForSqlParameter <span style="color:#e6db74">&#34;@datato&#34;</span> fc<span style="color:#f92672">.</span>To
    queryObj<span style="color:#f92672">.</span>parameters <span style="color:#f92672">|&gt;</span> checkForSqlParameter <span style="color:#e6db74">&#34;@locationid&#34;</span> fc<span style="color:#f92672">.</span>LocationId
 
    queryObj<span style="color:#f92672">.</span>query <span style="color:#f92672">|&gt;</span> should equal <span style="color:#e6db74">&#34;SELECT id, locationid, datafrom, datato, temperature, humidity, rain, windspeed, winddirection, clouds, pressure FROM </span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">intersect</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74">Weather</span><span style="color:#ae81ff">\&#34;</span><span style="color:#e6db74"> WHERE locationid = @locationid AND datafrom &gt;= @datafrom AND datato &lt;= @datato&#34;</span>

</code></pre></div><p>When was the last time, you could test which SQL- query gets executed against your DBS? 😉</p>


    

    


    <br/>
    <br/>
    <br/>
    <br/>
    &nbsp;
</article>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
    
        <section>
    
        
    
        
    
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
      






<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center">Disclaimer: The opinions expressed herein are my own personal opinions and do not represent my employer’s view in any way.</p>
        <p class="w-100 text-center">Hugo template made with ❤ by <a href="https://github.com/Xzya">Xzya</a>, inspired by <a href="https://github.com/alanorth/hugo-theme-bootstrap4-blog">hugo-theme-bootstrap4-blog</a></p>
    </nav>
</footer>

    

    
    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  </body>
</html>
